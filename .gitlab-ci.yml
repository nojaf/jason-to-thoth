variables:
#  SSH_CONNECTION: 'nojaf@'
  IMAGE_NAME: registry.gitlab.servers.mollux.be/nojaf/redhood:$CI_COMMIT_REF_NAME
  MASTER_PORT: 9700

stages:
  - endings
  - build
  - create
#  - deploy

fix line endings:
  stage: endings
  image: bash
  script:
    - find ./src -type f -print0 | xargs -0 dos2unix
    - find ./tests -type f -print0 | xargs -0 dos2unix
    - dos2unix build.fsx
    - dos2unix build.fsx.lock
    - dos2unix jason-to-thoth.sln
    - dos2unix paket.dependencies
    - dos2unix paket.lock
  tags:
    - docker
  only:
    - master

build code:
  stage: build
  image: vbfox/fable-build

  script:
    - dotnet tool install --tool-path ".paket" Paket --add-source https://api.nuget.org/v3/index.json
    - dotnet tool install fake-cli --tool-path .fake
    - .fake/fake run build.fsx -t Pack
  tags:
    - docker
  artifacts:
    name: "${CI_PROJECT_PATH}__${CI_BUILD_REF_NAME}"
    paths:
      - ./artifacts
    expire_in: 1h
  only:
    - master
  dependencies:
    - fix line endings

create container:
  stage: create
  script:
    - docker login -u gitlab-ci-token -p $CI_BUILD_TOKEN registry.gitlab.servers.mollux.be/
    - docker build -t ${IMAGE_NAME} .
    - docker push ${IMAGE_NAME}
  only:
    - master
  tags:
    - shell
  dependencies:
    - build code

#deploy container master:
#  stage: deploy
#  script:
#    - ssh ${SSH_CONNECTION} "sudo /var/www/vhosts/teams.budapestrally.org/reload_rds.sh $CI_COMMIT_REF_NAME $MASTER_PORT"
#  only:
#    - master
#  tags:
#    - shell
#  dependencies:
#    - create container
